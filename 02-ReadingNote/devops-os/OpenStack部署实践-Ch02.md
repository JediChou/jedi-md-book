# OpenStack部署实践-Ch02 - 阅读笔记
作者：张子凡
出版社：人民邮电出版社
ISBN：978-7-115-34679-7

## 第2章 OpenStack与网络
* Page 27, Target
  * “网桥：用于OpenStack FlatDHCP部署模式”
  * “VLAN：用于OpenStack VLAN部署模式”
  * “GRE：用于OpenStack multi namespace部署模式”
  * “VXLAN：用于OpenStack multi namespace部署及多数据中心迁移模式（后期版本）”
  
### 2.1 网卡管理工具ethtool
#### 2.1.1 安装与使用ethtool
* 安装
  ```bash
  # under ubuntu
  apt-get install ethtool
  # under centos
  yum install ethtool
  ```
* 查看网卡基础信息
  ```bash
  ethtool eth0  # under ubuntu
  ethtool em1   # under centos
  ```
* 重启网卡配置
  ```bash
  /etc/init.d/networking restart # under ubuntu
  service network restart # under centos
  ```

#### 2.1.2 网卡子接口
* Ubuntu配置多IP
  ```
  auto eth2
  iface eth2 inet static
  address 12.7.2.2
  netmask 255.0.0.0
  
  auto eth2:0
  iface eht2:0 inet static
  address 12.7.2.21
  netmask 255.0.0.0
  
  # 然后用ifconfig查看配置信息
  ```
* CentOS配置多IP
  ```
  DEVICE=em2
  ONBOOT=yes
  BOOTROTO=static
  IPADDR=192.168.1.100
  NETMASK=255.255.255.0
  GATEWAY=192.168.1.1
  ONPARENT=yes
  ```
  
#### 2.1.3 网卡信息文件
* Jedi: 以下配置文件解决VM被cp后无法ping其他节点的问题。
  ```
  # Notice: need delete 70-persistent-net.rules
  # This file was automatically generated by the /lib/udev/write_net_rules
  # program, run by the persistent-net-generator.rules rules file
  # You can modify it, as long as you keep each rule on a single
  # line, and change only the value of the NAME = key
  
  # PCI device 0x14e4:/sys/devices/pci0000:00/0000:00:03.0/0000:02:00.1 (bnx2)
  SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="78:2b:cb:43;5d:ce",
      ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL=="eth*", NAME="eth3"
	  
  # PCI device 0x14e4:/sys/devices/pci0000:00/0000:00:03.0/02:00.0 (bnx2)
  SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="78:2b:cb:43;5d:cc",
      ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL="eth*", NAME="eth2"
	  
  # PCI device 0x14e4:/sys/devices/pci0000:00/0000:00:01.0/01:00.1 (bnx2)
  SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="78:2b:cb:43;5d:ca",
      ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL="eth*", NAME="eth1"	
	  
  # PCI device 0x14e4:/sys/devices/pci0000:00/0000:00:01.0/01:00.0 (bnx2)
  SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="78:2b:cb:43;5d:c8",
      ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL="eth*", NAME="eth0"	
  ```
  
#### 2.1.4 OpenStack: 运用网卡子接口模拟多网卡
* Jedi: 这是必须要掌握的内容

### 2.2 网桥及网桥管理工具bridge-utils
* Page 31, “在Linux操作系统的KVM虚拟化环境内，为了挂载虚拟机，网桥接口的标识通常会是vnet0、vnet1等符号。”
* Page 32, 图2-1，这个图很重要
* Page 32, “由于很多虚拟机特别是OpenStack使用的qemu-kvm环境，其网卡标识都是自动创建的，因此我们不会讲解uml-utilities工具，而是将重点集中于如何使用该工具在系统中创建网桥。”
  * Jedi: 这个要特别注意下
  
#### 2.2.1 安装与使用bridge-utils
* 安装
  ```bash
  yum install bridge-utils
  brctl
  ```
* 使用
  ```bash
  brctl addbr br1
  brctl addif em1
  ifconfig em1 0.0.0.0
  ifconfig br1 172.21.1.3 netmask 255.255.0.0
  ```
* 显示端口信息
  ```bash
  brctl show br1
  ```
  
#### 2.2.2 理解网桥的IP地址与虚拟机的IP地址
* Page 33, “配置了网桥的IP地址后，即可通过Telnet或SSH以此IP地址访问宿主机。”
  * Jedi: 以下是一个ifconfig的输出，可供参考
    ```bash
	br1  Link encap:Ethernet HWaddr:D4:AE:52:64:04:06
	     inet addr:172.21.1.3  Bcast:172.21.255.255  Mask:255.255.0.0
		 inet6 addr: fe80::d6ae:52ff:fe64:406/64  Scope:Link
		 UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
		 RX packets:2029839 errors:0 dropped:0 overruns:0 frame:0/0
		 TX packets:66524 errors:0 dropped:0  overruns:0 carrier:0/0
		 collisions:0 txtqueuelen:0
		 RX bytes:111721520 (106.5 MiB)   TX bytes:6409933 (6.1 MiB)
	```
	
#### 2.2.3 Ubuntu系统下网络的配置文件
* Page 34, Ubuntu的网络配置相对简单，且比较集中，均在/etc/network/interfaces
  ```bash
  auto eth0
  iface eth0 inet manual
  
  auto br0
  iface br0 inet static
      address 192.168.3.3
	  netmask 255.255.255.0
	  gateway 192.168.3.1
	  bridge_ports eth0
  ```
  
#### 2.2.4 CentOS系统下网桥的配置文件
* Page 34, “br1网桥的配置文件ifcfg-br1的信息如下所示：”
  ```bash
  DEVICE="br1"
  TYPE=Bridge
  BOOTPROTO=static
  IPADDR=172.21.1.3
  NETMASK=255.255.0.0
  NETWORK=172.21.0.0
  GATEWAY=127.21.1.1
  DNS1=61.139.2.69
  ONBOOT="yes"
  ```
* Page 34, “此时em1网卡的配置文件ifcfg-em1的内容如下所示：”
  ```bash
  DEVICE="em1"
  HWADDR-"D4:AE:52:64:04:06"
  #NM_CONTROLLED="yes"
  ONBOOT="yes"
  BRIDGE="br1"
  ```
  
#### 2.2.5 将虚拟机与某个网桥连接
* Jedi: 概念倒是懂，实战方面还要和进勇探讨下

### 2.3 虚拟局域网VLAN
* Page 35, “当多个虚拟机都挂载在同一个网桥上时，由每个虚拟机发出的广播包而引起的广播风暴会使得网桥的通信吞吐能力大幅度下降，从而使虚拟机的网络性能急剧下降。”
* Page 35, “这种技术就是802.1Q机制，或者我们说的VLAN”
* Page 35, “当堕胎虚拟机被划分到不同的VLAN后，同一VLAN中的机器相当于连接在一个网桥中，而不同VLAN之间的通信是被隔离的。”

#### 2.3.1 VLAN协议802.1Q
* Page 35, “802.1Q的作用是将每个虚拟机发出的包加一个标签，一个局域网内共有4096个标签，每个标签可以看作一个独立的网络（Virtual LAN），每个虚拟机只能接收与自身VLAN号码相同的数据包”
* Page 36, 图2-3 对于理解特别重要

#### 2.3.2 接入端口与中继端口
* 接入端口（access port）
* 中继端口（trunk port）

#### 2.3.3 VLAN管理工具vconfig
* vconfig的安装
  ```bash
  apt-get install vlan
  modprobe 8021q
  ```
  * Page 37, “为了使机器下次启动时能自动加载802.1Q包，我们将其加入到/etc/modules文件中”